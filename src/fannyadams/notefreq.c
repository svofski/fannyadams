#include <math.h>
#include "notefreq.h"

/** Thanks to this wonderful answer:
 * https://dsp.stackexchange.com/a/1650
 */
float notefreq(midi_note_t note, int16_t pitchbend)
{
    return 440.0f * powf(2.0f, (note - 69)/12.0f + (pitchbend-8192)/(4096.f*12.f));
}

#if 0
// from http://tonalsoft.com/pub/news/pitch-bend.aspx

static
const float _12edo[] = {
// Octave -5
/* 0	C	*/ 8.1757989156,
/* 1	C#/Db	*/ 8.6619572180,
/* 2	D	*/ 9.1770239974,
/* 3	D#/Eb	*/ 9.7227182413,
/* 4	E	*/ 10.3008611535,
/* 5	F	*/ 10.9133822323,
/* 6	F#/Gb	*/ 11.5623257097,
/* 7	G	*/ 12.2498573744,
/* 8	G#/Ab	*/ 12.9782717994,
/* 9	A	*/ 13.7500000000,
/* 10	A#/Bb	*/ 14.5676175474,
/* 11	B	*/ 15.4338531643,

//Octave -4

/* 12	C	*/ 16.3515978313,
/* 13	C#/Db	*/ 17.3239144361,
/* 14	D	*/ 18.3540479948,
/* 15	D#/Eb	*/ 19.4454364826,
/* 16	E	*/ 20.6017223071,
/* 17	F	*/ 21.8267644646,
/* 18	F#/Gb	*/ 23.1246514195,
/* 19	G	*/ 24.4997147489,
/* 20	G#/Ab	*/ 25.9565435987,
/* 21	A	*/ 27.5000000000,
/* 22	A#/Bb	*/ 29.1352350949,
/* 23	B	*/ 30.8677063285,

// octave -3

/* 24	C	*/ 32.7031956626,
/* 25	C#/Db	*/ 34.6478288721,
/* 26	D	*/ 36.7080959897,
/* 27	D#/Eb	*/ 38.8908729653,
/* 28	E	*/ 41.2034446141,
/* 29	F	*/ 43.6535289291,
/* 30	F#/Gb	*/ 46.2493028390,
/* 31	G	*/ 48.9994294977,
/* 32	G#/Ab	*/ 51.9130871975,
/* 33	A	*/ 55.0000000000,
/* 34	A#/Bb	*/ 58.2704701898,
/* 35	B	*/ 61.7354126570,
//octave -2
/* 36	C	*/ 65.4063913251,
/* 37	C#/Db	*/ 69.2956577442,
/* 38	D	*/ 73.4161919794,
/* 39	D#/Eb	*/ 77.7817459305,
/* 40	E	*/ 82.4068892282,
/* 41	F	*/ 87.3070578583,
/* 42	F#/Gb	*/ 92.4986056779,
/* 43	G	*/ 97.9988589954,
/* 44	G#/Ab	*/ 103.8261743950,
/* 45	A	*/ 110.0000000000,
/* 46	A#/Bb	*/ 116.5409403795,
/* 47	B	*/ 123.4708253140,

// octave -1,

/* 48	C	*/ 130.8127826503,
/* 49	C#/Db	*/ 138.5913154884,
/* 50	D	*/ 146.8323839587,
/* 51	D#/Eb	*/ 155.5634918610,
/* 52	E	*/ 164.8137784564,
/* 53	F	*/ 174.6141157165,
/* 54	F#/Gb	*/ 184.9972113558,
/* 55	G	*/ 195.9977179909,
/* 56	G#/Ab	*/ 207.6523487900,
/* 57	A	*/ 220.0000000000,
/* 58	A#/Bb	*/ 233.0818807590,
/* 59	B	*/ 246.9416506281,
// octave 0
/* 60	C	*/ 261.6255653006,
/* 61	C#/Db	*/ 277.1826309769,
/* 62	D	*/ 293.6647679174,
/* 63	D#/Eb	*/ 311.1269837221,
/* 64	E	*/ 329.6275569129,
/* 65	F	*/ 349.2282314330,
/* 66	F#/Gb	*/ 369.9944227116,
/* 67	G	*/ 391.9954359817,
/* 70	G#/Ab	*/ 415.3046975799,
/* 69	A	*/ 440.0000000000,
/* 70	A#/Bb	*/ 466.1637615181,
/* 71	B	*/ 493.8833012561,
// octave 1
/* 72	C	*/ 523.2511306012,
/* 73	C#/Db	*/ 554.3652619537,
/* 74	D	*/ 587.3295358348,
/* 75	D#/Eb	*/ 622.2539674442,
/* 76	E	*/ 659.2551138257,
/* 77	F	*/ 698.4564628660,
/* 78	F#/Gb	*/ 739.9888454233,
/* 79	G	*/ 783.9908719635,
/* 80	G#/Ab	*/ 830.6093951599,
/* 81	A	*/ 880.0000000000,
/* 82	A#/Bb	*/ 932.3275230362,
/* 83	B	*/ 987.7666025122,
// octave 2
/* 84	C	*/ 1046.5022612024,
/* 85	C#/Db	*/ 1108.7305239075,
/* 86	D	*/ 1174.6590716696,
/* 87	D#/Eb	*/ 1244.5079348883,
/* 88	E	*/ 1318.5102276515,
/* 89	F	*/ 1396.9129257320,
/* 90	F#/Gb	*/ 1479.9776908465,
/* 91	G	*/ 1567.9817439270,
/* 92	G#/Ab	*/ 1661.2187903198,
/* 93	A	*/ 1760.0000000000,
/* 94	A#/Bb	*/ 1864.6550460724,
/* 95	B	*/ 1975.5332050245,
// octave 3
/* 96	C	*/ 2093.0045224048,
/* 97	C#/Db	*/ 2217.4610478150,
/* 98	D	*/ 2349.3181433393,
/* 99	D#/Eb	*/ 2489.0158697766,
/* 100	E	*/ 2637.0204553030,
/* 101	F	*/ 2793.8258514640,
/* 102	F#/Gb	*/ 2959.9553816931,
/* 103	G	*/ 3135.9634878540,
/* 104	G#/Ab	*/ 3322.4375806396,
/* 105	A	*/ 3520.0000000000,
/* 106	A#/Bb	*/ 3729.3100921447,
/* 107	B	*/ 3951.0664100490,
// octave 4
/* 108	C	*/ 4186.0090448096,
/* 109	C#/Db	*/ 4434.9220956300,
/* 110	D	*/ 4698.6362866785,
/* 111	D#/Eb	*/ 4978.0317395533,
/* 112	E	*/ 5274.0409106059,
/* 113	F	*/ 5587.6517029281,
/* 114	F#/Gb	*/ 5919.9107633862,
/* 115	G	*/ 6271.92697571  ,
/* 116	G#/Ab	*/ 6644.8751612791,
/* 117	A	*/ 7040.0000000000,
/* 118	A#/Bb	*/ 7458.6201842894,
/* 119	B	*/ 7902.1328200980,
// octave 5
/* 120	C	*/ 8372.0180896192,
/* 121	C#/Db	*/ 8869.8441912599,
/* 122	D	*/ 9397.2725733570,
/* 123	D#/Eb	*/ 9956.0634791066,
/* 124	E	*/ 10548.0818212118,
/* 125	F	*/ 11175.3034058561,
/* 126	F#/Gb	*/ 11839.8215267723,
/* 127	G	*/ 12543.8539514160,
};

float notefreq(midi_note_t note)
{
    if (note < 0) return 0;
    return _12edo[note];
}
#endif

